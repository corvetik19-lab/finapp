#!/usr/bin/env node
/**
 * –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ –∫—Ä–µ–¥–∏—Ç–∞–º
 * –ó–∞–ø—É—Å–∫: node scripts/apply-loan-payments-migration.mjs
 */

import { createClient } from '@supabase/supabase-js';
import { readFileSync } from 'fs';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';

// –ü–æ–ª—É—á–∞–µ–º –ø—É—Ç—å –∫ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// –ß–∏—Ç–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!supabaseUrl || !supabaseServiceKey) {
  console.error('‚ùå –û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è NEXT_PUBLIC_SUPABASE_URL –∏–ª–∏ SUPABASE_SERVICE_ROLE_KEY');
  console.log('–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª .env.local —Å–æ–¥–µ—Ä–∂–∏—Ç —ç—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ');
  process.exit(1);
}

// –°–æ–∑–¥–∞—ë–º –∫–ª–∏–µ–Ω—Ç Supabase
const supabase = createClient(supabaseUrl, supabaseServiceKey);

async function applyMigration() {
  try {
    console.log('üìÑ –ß—Ç–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏...');
    
    // –ß–∏—Ç–∞–µ–º SQL —Ñ–∞–π–ª
    const migrationPath = join(__dirname, '..', 'db', 'migrations', '20251005_auto_create_loan_payments.sql');
    const sql = readFileSync(migrationPath, 'utf-8');
    
    console.log('üöÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏...');
    
    // –í—ã–ø–æ–ª–Ω—è–µ–º SQL
    const { error } = await supabase.rpc('exec_sql', { sql_query: sql });
    
    if (error) {
      // –ï—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è exec_sql –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø–æ–ø—Ä–æ–±—É–µ–º –¥—Ä—É–≥–æ–π —Å–ø–æ—Å–æ–±
      console.log('‚ö†Ô∏è  –§—É–Ω–∫—Ü–∏—è exec_sql –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Supabase Dashboard ‚Üí SQL Editor');
      console.log('\nüìã –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞:');
      console.log('   db/migrations/20251005_auto_create_loan_payments.sql');
      console.log('\nüåê –ò –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤: https://supabase.com/dashboard/project/YOUR_PROJECT/sql');
      console.log('\nüìù –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–∏–≥—Ä–∞—Ü–∏–∏:');
      console.log('‚îÄ'.repeat(80));
      console.log(sql);
      console.log('‚îÄ'.repeat(80));
      return;
    }
    
    console.log('‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞!');
    console.log('\nüß™ –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ —Ñ—É–Ω–∫—Ü–∏–∏...');
    
    // –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é
    const { data: testData, error: testError } = await supabase.rpc('auto_create_loan_payments');
    
    if (testError) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏:', testError.message);
    } else {
      console.log('‚úÖ –§—É–Ω–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç!');
      console.log(`üìä –†–µ–∑—É–ª—å—Ç–∞—Ç: —Å–æ–∑–¥–∞–Ω–æ –ø–ª–∞—Ç–µ–∂–µ–π - ${testData?.[0]?.created_count ?? 0}`);
      console.log(`üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ: ${testData?.[0]?.message ?? 'OK'}`);
    }
    
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞:', error.message);
    process.exit(1);
  }
}

console.log('üîß –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ –∫—Ä–µ–¥–∏—Ç–∞–º\n');
applyMigration();
