# –°–≤—è–∑—å –ø–æ–∑–∏—Ü–∏–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —Å —Ç–æ–≤–∞—Ä–∞–º–∏ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø—Ä—è–º–∞—è —Å–≤—è–∑—å –º–µ–∂–¥—É –ø–æ–∑–∏—Ü–∏—è–º–∏ —Ç–æ–≤–∞—Ä–æ–≤ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö (`transaction_items`) –∏ —Ç–æ–≤–∞—Ä–∞–º–∏ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ (`product_items`). 

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤–æ –≤—Å–µ—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö
- ‚úÖ –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è ‚Üí –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤–µ–∑–¥–µ
- ‚úÖ –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–∞ ‚Üí –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤–æ –≤—Å–µ—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö
- ‚úÖ –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö –æ —Ç–æ–≤–∞—Ä–∞—Ö
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

## üóÑÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î

### –¢–∞–±–ª–∏—Ü–∞ `transaction_items`

```sql
ALTER TABLE transaction_items
ADD COLUMN product_id uuid REFERENCES product_items(id) ON DELETE SET NULL;
```

- `product_id` - —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ (nullable)
- –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ —Å–≤—è–∑—å –æ–±–Ω—É–ª—è–µ—Ç—Å—è (ON DELETE SET NULL)
- –°—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ –±–µ–∑ —Å–≤—è–∑–∏ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å

### VIEW `transaction_items_with_products`

```sql
CREATE OR REPLACE VIEW transaction_items_with_products AS
SELECT 
  ti.id,
  ti.transaction_id,
  ti.user_id,
  ti.product_id,
  -- –ù–∞–∑–≤–∞–Ω–∏–µ: –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ –µ—Å–ª–∏ –µ—Å—Ç—å —Å–≤—è–∑—å, –∏–Ω–∞—á–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ
  COALESCE(pi.name, ti.name) as name,
  ti.quantity,
  -- –ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è: –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ –µ—Å–ª–∏ –µ—Å—Ç—å —Å–≤—è–∑—å, –∏–Ω–∞—á–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è
  COALESCE(pi.default_unit, ti.unit) as unit,
  ti.price_per_unit,
  ti.total_amount,
  -- –ö–∞—Ç–µ–≥–æ—Ä–∏—è: –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ —Ç–æ–≤–∞—Ä–∞ –µ—Å–ª–∏ –µ—Å—Ç—å —Å–≤—è–∑—å, –∏–Ω–∞—á–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è
  COALESCE(pi.category_id, ti.category_id) as category_id,
  ti.created_at,
  ti.updated_at,
  -- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
  pi.name as product_name,
  pi.default_unit as product_unit,
  pi.category_id as product_category_id,
  c.name as category_name,
  c.kind as category_kind
FROM transaction_items ti
LEFT JOIN product_items pi ON ti.product_id = pi.id AND pi.is_active = true
LEFT JOIN categories c ON COALESCE(pi.category_id, ti.category_id) = c.id;
```

## üíª –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–¥–µ

### –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ —Ç–æ–≤–∞—Ä—É

```typescript
import { createTransactionItems } from "@/lib/transactions/transaction-items-service";

const items: TransactionItemInput[] = [
  {
    name: "–ú–æ–ª–æ–∫–æ",
    quantity: 2,
    unit: "–ª",
    price_per_unit: 8500, // –≤ –∫–æ–ø–µ–π–∫–∞—Ö
    product_id: "uuid-—Ç–æ–≤–∞—Ä–∞-–∏–∑-—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞" // –í–ê–ñ–ù–û!
  }
];

await createTransactionItems(transactionId, items);
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

```typescript
import { getTransactionItems } from "@/lib/transactions/transaction-items-service";

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç VIEW –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
const items = await getTransactionItems(transactionId);

// items[0].name - –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞
// items[0].unit - –∞–∫—Ç—É–∞–ª—å–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è
// items[0].category_name - –∞–∫—Ç—É–∞–ª—å–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è
```

## üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞

```sql
-- –ë—ã–ª–æ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ
UPDATE product_items SET name = '–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å' WHERE id = 'xxx';

-- –ò–∑–º–µ–Ω–∏–ª–∏
UPDATE product_items SET name = '–ö–∞—Ä—Ç–æ—à–∫–∞' WHERE id = 'xxx';

-- –†–µ–∑—É–ª—å—Ç–∞—Ç: –≤–æ –í–°–ï–• —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è "–ö–∞—Ä—Ç–æ—à–∫–∞"
```

### –ü—Ä–∏–º–µ—Ä 2: –ò–∑–º–µ–Ω–µ–Ω–∏–µ –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è

```sql
-- –ë—ã–ª–æ
UPDATE product_items SET default_unit = '—à—Ç' WHERE name = '–ú–æ–ª–æ–∫–æ';

-- –ò–∑–º–µ–Ω–∏–ª–∏
UPDATE product_items SET default_unit = '–ª' WHERE name = '–ú–æ–ª–æ–∫–æ';

-- –†–µ–∑—É–ª—å—Ç–∞—Ç: –≤–æ –í–°–ï–• —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è "–ª"
```

### –ü—Ä–∏–º–µ—Ä 3: –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

```sql
-- –ü–µ—Ä–µ–º–µ—Å—Ç–∏–ª–∏ —Ç–æ–≤–∞—Ä –≤ –¥—Ä—É–≥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
UPDATE product_items 
SET category_id = (SELECT id FROM categories WHERE name = '–ü—Ä–æ–¥—É–∫—Ç—ã')
WHERE name = '–•–ª–µ–±';

-- –†–µ–∑—É–ª—å—Ç–∞—Ç: –≤–æ –í–°–ï–• —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö —Ö–ª–µ–± —Ç–µ–ø–µ—Ä—å –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–ü—Ä–æ–¥—É–∫—Ç—ã"
```

## üìä –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö

–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–æ–ª—è `product_id` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–ø–æ–ª–Ω–∏–ª–∞—Å—å –º–∏–≥—Ä–∞—Ü–∏—è:

```sql
-- –°–≤—è–∑—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏ —Å —Ç–æ–≤–∞—Ä–∞–º–∏ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
UPDATE transaction_items ti
SET product_id = pi.id
FROM product_items pi
WHERE ti.product_id IS NULL
  AND ti.user_id = pi.user_id
  AND LOWER(TRIM(ti.name)) = LOWER(TRIM(pi.name))
  AND pi.is_active = true;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –≤—Å–µ 48 —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø–∏—Å–µ–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≤—è–∑–∞–ª–∏—Å—å —Å —Ç–æ–≤–∞—Ä–∞–º–∏! ‚úÖ

## üéØ –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ–∫–æ–≤

–ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —á–µ–∫–æ–≤ —á–µ—Ä–µ–∑ AI –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è `product_id`:

```typescript
// –í lib/ai/tool-handlers.ts
await supabase
  .from("transaction_items")
  .insert({
    user_id: userId,
    transaction_id: transaction.id,
    name: matchedProduct.name,
    quantity: receiptItem.quantity,
    unit: '—à—Ç',
    price_per_unit: Math.round(receiptItem.pricePerUnit * 100),
    total_amount: Math.round(receiptItem.total * 100),
    category_id: matchedProduct.category_id,
    product_id: matchedProduct.id // ‚Üê –°–≤—è–∑—å —Å —Ç–æ–≤–∞—Ä–æ–º!
  });
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: –°—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ –±–µ–∑ `product_id` –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
2. **–£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞**: –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ `product_id` –æ–±–Ω—É–ª—è–µ—Ç—Å—è (ON DELETE SET NULL)
3. **–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã**: VIEW –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã (`pi.is_active = true`)
4. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–∞–Ω–Ω—ã—Ö**: –ï—Å–ª–∏ –µ—Å—Ç—å `product_id` ‚Üí –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞, –∏–Ω–∞—á–µ ‚Üí —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è

## üöÄ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

- **–ï–¥–∏–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏**: –ò–∑–º–µ–Ω–∏–ª –æ–¥–∏–Ω —Ä–∞–∑ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ ‚Üí –æ–±–Ω–æ–≤–∏–ª–æ—Å—å –≤–µ–∑–¥–µ
- **–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**: –í—Å–µ–≥–¥–∞ –≤–∏–¥–∏—à—å —Ç–µ–∫—É—â–µ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ç–æ–≤–∞—Ä–∞
- **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞**: –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –¥–∞–∂–µ –µ—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Ç–æ–≤–∞—Ä–∞ –º–µ–Ω—è–ª–∞—Å—å
- **–£–¥–æ–±—Å—Ç–≤–æ**: –ù–µ –Ω—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é –æ–±–Ω–æ–≤–ª—è—Ç—å —Å—Ç–∞—Ä—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

## üìù –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω–∏–π

- `db/migrations/20251113_add_product_id_to_transaction_items.sql` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è
- `db/migrations/20251113_create_transaction_items_view.sql` - —Å–æ–∑–¥–∞–Ω–∏–µ VIEW
- `types/transaction.ts` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∏–ø–æ–≤
- `lib/transactions/transaction-items-service.ts` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ VIEW
- `lib/ai/tool-handlers.ts` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ product_id –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —á–µ–∫–æ–≤
