# CSV Import/Export — Draft Scope

## Цель
Добавить удобный импорт и экспорт транзакций в формате CSV на странице `app/(protected)/transactions/page.tsx`, с учётом бизнес-правил проекта (валидация, дубликаты, категория/валюта, RLS Supabase).

## Область покрытия
- Импорт CSV во встроенную модалку с предпросмотром.
- Экспорт CSV с учётом активных фильтров пользователя.
- Интеграция с существующими сервисами `lib/transactions/service.ts` и UI-компонентами `components/transactions/*`.

## Основные сценарии
- **Импорт (happy-path)**: пользователь выбирает CSV → файл парсится PapaParse → предварительный просмотр → валидация Zod → отправка на серверный action → пакетное вставление транзакций в Supabase.
- **Импорт (ошибки)**: неправильные заголовки, пропуски колонок, некорректные значения → отображается список ошибок, возможность скачать отчёт об ошибках и повторить импорт.
- **Дубликаты**: при повторной загрузке тех же транзакций пользователь получает предупреждение и может пропустить/перезаписать.
- **Экспорт**: пользователь нажимает «Экспорт CSV» → файл скачивается с данными по текущим фильтрам (`searchParams`) и сортировке.

## Формат CSV
- Заголовки (RU / EN? → выбрать RU, т.к. UI на русском).
- Обязательные колонки:
  - `Дата` (ISO 8601 или `ДД.ММ.ГГГГ ЧЧ:ММ`).
  - `Тип` (`income` | `expense` | `transfer`).
  - `Сумма` (major units с точкой как разделителем).
  - `Валюта` (ISO 4217).
- Необязательные:
  - `Счёт`, `Категория`, `Контрагент`, `Заметка`, `Теги`.
- Дополнительные: `ID` (для экспорта) чтобы помочь в дедупликации.

## Импорт: детальный поток
1. UI: кнопка `Импорт` (в `components/transactions/Transactions.module.css`) снимает `disabled`. При клике открывается `ImportCsvModal`.
2. Модалка загружает файл (через `<input type="file">`).
3. PapaParse (клиент) парсит CSV → результат отправляется в Zod-схему `lib/csv/import-schema.ts`.
4. Валидация возвращает:
   - нормализованные данные (ISO-дату, major → minor, slug для категорий/счетов).
   - список ошибок по строкам.
5. Модалка показывает preview: таблица, ошибки, кнопка «Импортировать N транзакций».
6. По клику — вызываем `importTransactionsAction` (server action):
   - маппинг `Счёт` и `Категория` по названию → ID.
   - создание недостающих категорий? (решить: MVP — ошибка, подсказка);
   - проверка на дубликаты (`id`, `occurred_at`, `amount`, `direction`).
   - вставка через `supabase.from("transactions").insert(bulk)` внутри транзакции.
7. Результат → UI показывает успех (кол-во импортированных, пропущенных, дубликатов).

## Экспорт: детальный поток
1. Кнопка `Экспорт CSV` снимаем `disabled`.
2. При клике → серверное действие `exportTransactionsAction(searchParams)`:
   - использует тот же фильтр, что и список (`listTransactions`).
   - преобразует записи в CSV строку с заголовками.
   - использует `next/headers` для `Content-Disposition` (Stream / Response).
3. Client-side — инициирует скачивание (через a.download или fetch+blob).

## Технические компоненты
- `components/transactions/ImportCsvModal.tsx`
- `lib/csv/import-schema.ts` (Zod-валидация + нормализация)
- `lib/csv/utils.ts` (хелперы: parseDate, parseAmount, detectDuplicates)
- `app/(protected)/transactions/actions.ts`
  - `importTransactionsAction`
  - `exportTransactionsAction`

## Валидация и сообщения
- Zod: форматы даты, суммы, валюта (проверка на ISO 4217).
- Ожидаемые ошибки: пустой файл, неизвестные заголовки, неверные значения.
- Предпросмотр показывает макс. 100 строк (пагинация/scroll).

## Дедупликация
- MVP: предупреждаем пользователя, что строки с одинаковой комбинацией (`occurred_at`, `amount`, `direction`, `account_id`, `category_id`) будут пропущены.
- Опционально позже — поведение «обновить существующую».

## Логирование и отслеживание
- Журнал импортов (опционально): `lib/csv/import-history.ts` + таблица в БД?
- В MVP — показываем количество вставленных/пропущенных строк.

## Тестирование
- Unit: Zod-schema, normalize функции.
- Playwright: загрузка CSV → проверка предпросмотра → импорт → проверка списка транзакций.
- Export: Playwright скачивает файл, проверяет, что содержимое соответствует фильтрам.

## Открытые вопросы
- Создаём ли автоматом категории/счета? (пока — нет, ошибки).
- Поддерживаем ли `transfer` (две записи)? Возможно, в CSV задавать два счёта.
- Нужно ли сохранять историю импортов для отката? Пока MVP — лог в UI.

## Следующие шаги
1. Подготовить `lib/csv/import-schema.ts` и хелперы.
2. Сделать модалку и предпросмотр.
3. Реализовать серверный action с дедупликацией.
4. Сделать экспорт action и кнопку.
5. Написать мануальные шаги в `docs/manual-tests/csv.md`.
