# Логика перемещения тендеров между этапами

**Дата:** 13.11.2025  
**Статус:** Завершено

## Обзор

Реализована бизнес-логика последовательного перемещения тендеров между этапами с учётом специальных правил.

## Правила перемещения

### 1. Последовательное перемещение

По умолчанию тендеры можно перемещать **только на соседние этапы** (предыдущий или следующий):

```
Анализ и просчёт → Проверка → Подача → Подан. Рассмотрение заявки → ...
```

**Нельзя:**
- Перепрыгивать через этапы
- Перемещать из "Анализ и просчёт" сразу в "Подача"

**Можно:**
- Из "Анализ и просчёт" в "Проверка"
- Из "Проверка" обратно в "Анализ и просчёт"
- Из "Проверка" в "Подача"

### 2. Специальные правила для этапа "Проверка"

С этапа **"Проверка"** можно переместить тендер в:
- ✅ **Подача** (следующий этап)
- ✅ **Не участвуем** (отказ от участия)
- ✅ **Не прошло проверку** (не прошёл внутреннюю проверку)
- ✅ **Не подано** (не успели подать)

Это позволяет быстро отклонять тендеры на этапе проверки без прохождения всех промежуточных этапов.

### 3. Визуальная индикация

При попытке перетащить карточку на недопустимый этап:
- Колонка **не подсвечивается** при наведении
- При drop показывается **alert** с сообщением об ошибке
- Карточка остаётся на исходном месте

## Скрытие пустых этапов

Добавлена возможность скрывать этапы без тендеров для улучшения обзора.

### Функционал

**Чекбокс "Скрыть пустые этапы":**
- Расположен над канбан-доской
- Сохраняется в localStorage
- Фильтрует этапы в реальном времени

**Поведение:**
- ✅ Включено: показываются только этапы с тендерами
- ❌ Выключено: показываются все этапы

## Реализация

### Функция проверки возможности перемещения

```typescript
const canMoveToStage = (fromStageId: string, toStageId: string): boolean => {
  if (fromStageId === toStageId) return false;

  const fromStage = stages.find(s => s.id === fromStageId);
  const toStage = stages.find(s => s.id === toStageId);
  
  if (!fromStage || !toStage) return false;

  // Специальные правила для этапа "Проверка"
  if (fromStage.name === 'Проверка') {
    const allowedFromCheck = ['Не участвуем', 'Не прошло проверку', 'Не подано', 'Подача'];
    return allowedFromCheck.includes(toStage.name);
  }

  // Для остальных этапов - только последовательное перемещение
  const fromIndex = fromStage.order_index;
  const toIndex = toStage.order_index;

  // Можно перемещать только на следующий или предыдущий этап
  return Math.abs(toIndex - fromIndex) === 1;
};
```

### Обработчик drag over

```typescript
const handleDragOver = (e: React.DragEvent, stageId: string) => {
  e.preventDefault();
  
  // Проверяем возможность перемещения
  if (draggedTender && canMoveToStage(draggedTender.stage_id, stageId)) {
    setDragOverStage(stageId); // Подсвечиваем только допустимые колонки
  }
};
```

### Обработчик drop

```typescript
const handleDrop = async (e: React.DragEvent, stageId: string) => {
  e.preventDefault();
  
  // Проверяем возможность перемещения
  if (draggedTender && !canMoveToStage(draggedTender.stage_id, stageId)) {
    alert('Нельзя перепрыгивать через этапы. Перемещайте последовательно.');
    setDraggedTender(null);
    setDragOverStage(null);
    return;
  }
  
  // ... остальная логика перемещения
};
```

### Фильтрация пустых этапов

```typescript
const [hideEmptyStages, setHideEmptyStages] = useState(false);

// Фильтруем этапы если включено скрытие пустых
const visibleStages = hideEmptyStages 
  ? stages.filter(stage => (optimisticTenders[stage.id] || []).length > 0)
  : stages;
```

## Диаграмма потока

```
┌─────────────────────┐
│ Анализ и просчёт    │
└──────────┬──────────┘
           │ ↓ (только вперёд/назад)
┌──────────▼──────────┐
│ Проверка            │──┐
└──────────┬──────────┘  │
           │ ↓            │ (специальные переходы)
           │              │
           │              ├──→ Не участвуем
           │              ├──→ Не прошло проверку
           │              └──→ Не подано
           │
┌──────────▼──────────┐
│ Подача              │
└──────────┬──────────┘
           │ ↓
┌──────────▼──────────┐
│ Подан. Рассмотрение │
└──────────┬──────────┘
           │ ↓
          ...
```

## Изменённые файлы

1. `components/tenders/tender-kanban.tsx`
   - Функция `canMoveToStage` - проверка правил
   - Обновлённые обработчики drag & drop
   - Фильтрация пустых этапов
   - Панель управления с чекбоксом

2. `components/tenders/tender-kanban.module.css`
   - Стили для панели управления
   - Стили для чекбокса

3. `docs/TENDER_STAGE_LOGIC.md`
   - Документация правил

## Результат

✅ **Защита от ошибок:**
- Нельзя перепрыгнуть через этапы
- Визуальная индикация допустимых переходов
- Понятные сообщения об ошибках

✅ **Гибкость:**
- Специальные правила для этапа "Проверка"
- Быстрое отклонение тендеров

✅ **Удобство:**
- Скрытие пустых этапов
- Сохранение настроек в localStorage
