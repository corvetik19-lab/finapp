# Справочник товаров и позиций

## Описание
Функционал справочника товаров позволяет пользователям создавать и управлять списком часто покупаемых товаров. При добавлении позиций в транзакции доступно автодополнение с поиском по справочнику.

## Структура БД

### Таблица `product_items`
```sql
- id: UUID (PK)
- user_id: UUID (FK -> auth.users)
- name: TEXT (название товара)
- default_unit: TEXT (единица измерения по умолчанию)
- default_price_per_unit: BIGINT (цена в копейках, nullable)
- category: TEXT (категория товара, nullable)
- description: TEXT (описание, nullable)
- is_active: BOOLEAN (активность)
- created_at: TIMESTAMPTZ
- updated_at: TIMESTAMPTZ
```

**RLS политики:** Пользователи могут видеть и управлять только своими товарами.

## Компоненты

### 1. ProductItemsManager (`components/product-items/ProductItemsManager.tsx`)
- Управление справочником товаров
- CRUD операции (создание, редактирование, удаление)
- Отображение списка товаров в таблице
- Форма добавления/редактирования товара

### 2. ProductAutocomplete (`components/transactions/ProductAutocomplete.tsx`)
- Поле ввода с автодополнением
- Поиск товаров по названию (debounce 300ms)
- Навигация клавиатурой (↑↓, Enter, Esc)
- Отображение подсказок с ценой и категорией

### 3. TransactionItems (обновлён)
- Интегрирован компонент `ProductAutocomplete`
- При выборе товара автоматически заполняются:
  - Название
  - Единица измерения
  - Цена по умолчанию

## API (Server Actions)

### `lib/product-items/service.ts`
- `getProductItems(activeOnly)` - получить список товаров
- `searchProductItems(query)` - поиск товаров (для автодополнения)
- `createProductItem(input)` - создать товар
- `updateProductItem(update)` - обновить товар
- `deleteProductItem(id)` - мягкое удаление (деактивация)
- `permanentDeleteProductItem(id)` - физическое удаление

## Страницы

### `/finance/settings/products`
Страница управления справочником товаров:
- Список всех товаров пользователя
- Форма добавления нового товара
- Редактирование существующих товаров
- Деактивация товаров

### Доступ из настроек
В `/finance/settings` добавлена секция "Справочник товаров" с кнопкой "Управление товарами".

## Использование

### 1. Добавление товаров в справочник
1. Перейти в Настройки → Управление товарами

Страница: `/finance/settings/products`

### Добавление товара
- Название (обязательно)
- Единица измерения (обязательно) — выбор из списка: шт, кг, л, г, мл, упак, м, м²
- Цена за единицу (опционально)
- Категория (опционально) — выбирается из существующих категорий приложения
  - В списке отображаются только категории типов «Доход» и «Расход»
  - Категории сгруппированы по типам: секции «Доходы» и «Расходы»
- Описание (опционально)
4. Нажать "Добавить"

### 2. Использование в транзакциях
1. Создать новую транзакцию
2. Отметить чекбокс "Добавить позиции товаров"
3. Начать вводить название товара в поле
4. Выбрать товар из выпадающего списка
5. Автоматически заполнятся:
   - Единица измерения
   - Цена за единицу
   - Категория товара (если указана в справочнике)
6. При необходимости изменить количество или цену
7. Нажать "Добавить"
8. В списке позиций отображается название товара и его категория

## Особенности

### Автодополнение и выбор товаров
- **Автодополнение:** поиск начинается после ввода 2+ символов
- **Выпадающий список:** кнопка со стрелкой показывает все товары
- Debounce 300ms для оптимизации запросов
- **Отображается:** название, описание (если есть), цена, категория
- Поддержка навигации клавиатурой (↑↓, Enter, Esc)
- **Валидация:** можно добавить только товары из справочника
- Визуальная индикация невалидного товара (красная рамка + сообщение)
- После выбора товара список автоматически закрывается

### Мягкое удаление
- Товары не удаляются физически, а деактивируются
- Неактивные товары не показываются в автодополнении
- В списке управления видны все товары (активные и неактивные)

### Валидация
- **Название товара обязательно**
- **Единица измерения обязательна** (нельзя добавить товар без единицы)
- Цена хранится в копейках (умножается на 100)
- Единица измерения по умолчанию "шт"
- В транзакциях единица измерения **только для чтения** (автоматически из справочника)

## Миграция

Файл: `db/migrations/20251106_create_product_items.sql`

Применить миграцию через Supabase Dashboard или CLI:
```bash
supabase db push
```

## Типы

### `types/product-item.ts`
```typescript
type ProductItem = {
  id: string;
  user_id: string;
  name: string;
  default_unit: string;
  default_price_per_unit: number | null;
  category: string | null;
  description: string | null;
  is_active: boolean;
  created_at: string;
  updated_at: string;
};

type ProductItemInput = {
  name: string;
  default_unit: string;
  default_price_per_unit?: number | null;
  category?: string | null;
  description?: string | null;
  is_active?: boolean;
};
```

## Будущие улучшения

- [ ] Импорт товаров из CSV
- [ ] Экспорт справочника
- [ ] Группировка товаров по категориям
- [ ] История изменения цен
- [ ] Статистика по товарам (частота покупок, средняя цена)
- [ ] Избранные товары
- [ ] Штрихкоды товаров
