# Синхронизация этапов между настройками и тендерным отделом

## 🔄 Как это работает

При изменении этапов в настройках (добавление, удаление, изменение порядка), канбан-доска в тендерном отделе **автоматически обновляется** в реальном времени.

## ✨ Возможности

### 1. Автоматическое обновление

**Когда обновляется:**
- ✅ При добавлении нового этапа
- ✅ При редактировании существующего этапа
- ✅ При удалении этапа
- ✅ При изменении порядка этапов (drag-and-drop)

**Где обновляется:**
- ✅ В текущей вкладке (мгновенно)
- ✅ В других открытых вкладках браузера (через localStorage)
- ✅ На странице "Тендерный отдел" (канбан-доска)

### 2. Технология синхронизации

**События:**
- Используется система событий через `CustomEvent`
- Кросс-табовая синхронизация через `localStorage`
- Подписка на обновления через `subscribeToStagesUpdates()`

**Файлы:**
- `lib/tenders/events.ts` - система событий
- `app/(protected)/tenders/settings/tender-settings-complete.tsx` - отправка событий
- `app/(protected)/tenders/department/tender-department-client.tsx` - получение событий

## 🎯 Примеры использования

### Сценарий 1: Добавление нового этапа

1. Откройте **Настройки тендеров** → **Этапы**
2. Нажмите **"Создать этап"**
3. Заполните данные и сохраните
4. **Результат:** Новый этап мгновенно появится в канбан-доске

### Сценарий 2: Изменение порядка

1. Откройте **Настройки тендеров** → **Этапы**
2. Перетащите этап на новую позицию (drag-and-drop)
3. **Результат:** Порядок колонок в канбан-доске обновится автоматически

### Сценарий 3: Удаление этапа

1. Откройте **Настройки тендеров** → **Этапы**
2. Нажмите 🗑️ на этапе и подтвердите удаление
3. **Результат:** Этап исчезнет из канбан-доски

### Сценарий 4: Работа в нескольких вкладках

1. Откройте **Тендерный отдел** в одной вкладке
2. Откройте **Настройки этапов** в другой вкладке
3. Измените этапы в настройках
4. **Результат:** Канбан-доска в первой вкладке обновится автоматически

## 🔧 Техническая реализация

### Отправка события (в настройках)

```typescript
import { notifyStagesUpdated } from '@/lib/tenders/events';

// После создания/обновления/удаления этапа
notifyStagesUpdated();
```

### Получение события (в тендерном отделе)

```typescript
import { subscribeToStagesUpdates } from '@/lib/tenders/events';

useEffect(() => {
  // Подписываемся на обновления
  const unsubscribe = subscribeToStagesUpdates(() => {
    console.log('Stages updated, reloading...');
    loadStages(); // Перезагружаем этапы
  });

  return () => {
    unsubscribe(); // Отписываемся при размонтировании
  };
}, []);
```

### Загрузка этапов

```typescript
const loadStages = async () => {
  try {
    const response = await fetch(`/api/tenders/stages?company_id=${companyId}`);
    if (response.ok) {
      const result = await response.json();
      const allStages = result.data || [];
      // Фильтруем только этапы тендерного отдела
      const departmentStages = allStages.filter(
        (s: TenderStage) => s.category === 'tender_dept'
      );
      setStages(departmentStages);
    }
  } catch (error) {
    console.error('Error loading stages:', error);
  }
};
```

## 📊 Диаграмма работы

```
┌─────────────────────┐
│  Настройки этапов   │
│  (Settings Page)    │
└──────────┬──────────┘
           │
           │ 1. Изменение этапа
           ▼
┌─────────────────────┐
│  notifyStagesUpdated│
│  (Event Trigger)    │
└──────┬──────────────┘
       │
       ├─────────────────────┐
       │                     │
       ▼                     ▼
┌─────────────┐    ┌──────────────────┐
│ CustomEvent │    │ localStorage     │
│ (same tab)  │    │ (other tabs)     │
└──────┬──────┘    └────────┬─────────┘
       │                    │
       └────────┬───────────┘
                │
                ▼
┌────────────────────────────┐
│ subscribeToStagesUpdates   │
│ (Event Listener)           │
└──────────┬─────────────────┘
           │
           │ 2. Получение события
           ▼
┌─────────────────────┐
│    loadStages()     │
│  (Reload stages)    │
└──────────┬──────────┘
           │
           │ 3. Обновление UI
           ▼
┌─────────────────────┐
│  Тендерный отдел    │
│  (Kanban Board)     │
└─────────────────────┘
```

## ✅ Преимущества

1. **Мгновенность** - изменения видны сразу
2. **Синхронизация** - работает между вкладками
3. **Надёжность** - не требует перезагрузки страницы
4. **Простота** - работает автоматически
5. **Производительность** - обновляется только при изменениях

## 🚀 Будущие улучшения

- [ ] WebSocket для синхронизации между пользователями
- [ ] Оптимистичные обновления с откатом при ошибке
- [ ] Анимации при добавлении/удалении этапов
- [ ] Уведомления о конфликтах при одновременном редактировании
