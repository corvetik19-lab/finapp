# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Å –∫—É–±—ã—à–∫–æ–π

**–ö—É–±—ã—à–∫–∞** ‚Äî —ç—Ç–æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç –æ—Ç –±–∞–Ω–∫–∞ (–∫–∞–∫ –æ–≤–µ—Ä–¥—Ä–∞—Ñ—Ç), –∫–æ—Ç–æ—Ä—ã–π –≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–µ –¥–µ–Ω–µ–≥ –Ω–∞ –∫–∞—Ä—Ç–µ.

## –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫—É–±—ã—à–∫–∞

**–ö—É–±—ã—à–∫–∞ - —ç—Ç–æ –ù–ï –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è!** –≠—Ç–æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –¥–µ–Ω—å–≥–∏ –±–∞–Ω–∫–∞.

- `target_amount` = –ª–∏–º–∏—Ç –∫—É–±—ã—à–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 50 000 ‚ÇΩ) - –ù–ï–ò–ó–ú–ï–ù–ï–ù
- `balance` = —Å–∫–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ = `target_amount - balance`

**–ò–∑–Ω–∞—á–∞–ª—å–Ω–æ:** `balance = target_amount` (50 000 ‚ÇΩ –¥–æ—Å—Ç—É–ø–Ω–æ, 0 ‚ÇΩ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ)

### 1. **–ü—Ä–∏ —Ä–∞—Å—Ö–æ–¥–µ —Å –∫–∞—Ä—Ç—ã**

- –ï—Å–ª–∏ –Ω–∞ –∫–∞—Ä—Ç–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ë–ï–†–£–¢–°–Ø –¥–µ–Ω—å–≥–∏ –∏–∑ –∫—É–±—ã—à–∫–∏ (—É–º–µ–Ω—å—à–∞–µ—Ç—Å—è `balance`)
- –ö–∞—Ä—Ç–∞ –ø–æ–ø–æ–ª–Ω—è–µ—Ç—Å—è –∑–∞ —Å—á—ë—Ç –∫—É–±—ã—à–∫–∏ –ü–ï–†–ï–î —Å–ø–∏—Å–∞–Ω–∏–µ–º
- –ö–∞—Ä—Ç–∞ **–Ω–∏–∫–æ–≥–¥–∞** –Ω–µ —É—Ö–æ–¥–∏—Ç –≤ –º–∏–Ω—É—Å ‚ùå

### 2. **–ü—Ä–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–∞—Ä—Ç—ã**

- –ï—Å–ª–∏ –∫—É–±—ã—à–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å (`balance < target_amount`)
- –î–µ–Ω—å–≥–∏ –°–ù–ê–ß–ê–õ–ê –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –¥–æ–ª–≥ –∫—É–±—ã—à–∫–µ (—É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è `balance`)
- –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–≥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞ –¥–æ–ª–≥–∞ –¥–µ–Ω—å–≥–∏ –∏–¥—É—Ç –Ω–∞ —Å–∞–º—É –∫–∞—Ä—Ç—É

**–§—É–Ω–∫—Ü–∏—è:** `addFundsAction`

```typescript
// –õ–æ–≥–∏–∫–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è:
1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∫—É–±—ã—à–∫–∞ —É –∫–∞—Ä—Ç—ã
2. –ï—Å–ª–∏ –∫—É–±—ã—à–∫–∞ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞:
   - –í—ã—á–∏—Å–ª—è–µ–º —Å–∫–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ –¥–æ —Ü–µ–ª–∏
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –∫—É–±—ã—à–∫—É min(—Å—É–º–º–∞_–ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è, –Ω—É–∂–Ω–æ_–¥–æ_—Ü–µ–ª–∏)
   - –û—Å—Ç–∞—Ç–æ–∫ (–µ—Å–ª–∏ –µ—Å—Ç—å) –∏–¥—ë—Ç –Ω–∞ –∫–∞—Ä—Ç—É
3. –ï—Å–ª–∏ –∫—É–±—ã—à–∫–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞:
   - –í—Å—è —Å—É–º–º–∞ –∏–¥—ë—Ç –Ω–∞ –∫–∞—Ä—Ç—É
```

### Database: –¢—Ä–∏–≥–≥–µ—Ä

**–§–∞–π–ª:** `db/migrations/20251009_auto_stash_withdrawal.sql`

**–§—É–Ω–∫—Ü–∏–∏:**

- `auto_withdraw_from_stash_before()` - BEFORE INSERT —Ç—Ä–∏–≥–≥–µ—Ä
- `auto_withdraw_from_stash_after()` - AFTER INSERT —Ç—Ä–∏–≥–≥–µ—Ä

```sql
-- BEFORE INSERT —Ç—Ä–∏–≥–≥–µ—Ä —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –î–û —Å–æ–∑–¥–∞–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
-- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ö–≤–∞—Ç–∏—Ç –ª–∏ –¥–µ–Ω–µ–≥ –Ω–∞ —Å—á—ë—Ç–µ –ü–û–°–õ–ï —Ä–∞—Å—Ö–æ–¥–∞
-- –ï—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∏—Ç:
--   1. –ù–∞—Ö–æ–¥–∏—Ç –∫—É–±—ã—à–∫—É
--   2. –í—ã—á–∏—Å–ª—è–µ—Ç —Å–∫–æ–ª—å–∫–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç
--   3. –°–ø–∏—Å—ã–≤–∞–µ—Ç –∏–∑ –∫—É–±—ã—à–∫–∏ min(–Ω–µ—Ö–≤–∞—Ç–∫–∞, –±–∞–ª–∞–Ω—Å_–∫—É–±—ã—à–∫–∏)
--   4. –ü–æ–ø–æ–ª–Ω—è–µ—Ç —Å—á—ë—Ç –ó–ê–†–ê–ù–ï–ï
--   5. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–µ—Ä–µ–≤–æ–¥–µ
-- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å —É–∂–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –±–∞–ª–∞–Ω—Å–æ–º

-- AFTER INSERT —Ç—Ä–∏–≥–≥–µ—Ä –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–≤–æ–¥–∞
```

---

## üìä –ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç—ã

### –ü—Ä–∏–º–µ—Ä 1: –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã –ø—Ä–∏ –ø—É—Å—Ç–æ–π –∫—É–±—ã—à–∫–µ

```text
–ë–∞–ª–∞–Ω—Å –∫–∞—Ä—Ç—ã: 0 ‚ÇΩ
–ë–∞–ª–∞–Ω—Å –∫—É–±—ã—à–∫–∏: 0 ‚ÇΩ
–¶–µ–ª—å –∫—É–±—ã—à–∫–∏: 50 000 ‚ÇΩ

–ü–æ–ø–æ–ª–Ω—è–µ–º –∫–∞—Ä—Ç—É: 100 000 ‚ÇΩ

–†–µ–∑—É–ª—å—Ç–∞—Ç:
- –ë–∞–ª–∞–Ω—Å –∫—É–±—ã—à–∫–∏: 50 000 ‚ÇΩ ‚úÖ
- –ë–∞–ª–∞–Ω—Å –∫–∞—Ä—Ç—ã: 50 000 ‚ÇΩ
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è: +50 000 ‚ÇΩ "–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã (–ø–æ—Å–ª–µ –∫—É–±—ã—à–∫–∏)"
```

### –ü—Ä–∏–º–µ—Ä 2: –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã –ø—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–π –∫—É–±—ã—à–∫–µ

```text
–ë–∞–ª–∞–Ω—Å –∫–∞—Ä—Ç—ã: 10 000 ‚ÇΩ
–ë–∞–ª–∞–Ω—Å –∫—É–±—ã—à–∫–∏: 50 000 ‚ÇΩ (–∑–∞–ø–æ–ª–Ω–µ–Ω–∞)
–¶–µ–ª—å –∫—É–±—ã—à–∫–∏: 50 000 ‚ÇΩ

–ü–æ–ø–æ–ª–Ω—è–µ–º –∫–∞—Ä—Ç—É: 20 000 ‚ÇΩ

–†–µ–∑—É–ª—å—Ç–∞—Ç:
- –ë–∞–ª–∞–Ω—Å –∫—É–±—ã—à–∫–∏: 50 000 ‚ÇΩ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
- –ë–∞–ª–∞–Ω—Å –∫–∞—Ä—Ç—ã: 30 000 ‚ÇΩ ‚úÖ
- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è: +20 000 ‚ÇΩ "–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã"
```

### –ü—Ä–∏–º–µ—Ä 3: –†–∞—Å—Ö–æ–¥ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Å–ø–∏—Å–∞–Ω–∏–µ–º –∏–∑ –∫—É–±—ã—à–∫–∏

```text
–ë–∞–ª–∞–Ω—Å –∫–∞—Ä—Ç—ã: 20 000 ‚ÇΩ
–ë–∞–ª–∞–Ω—Å –∫—É–±—ã—à–∫–∏: 40 000 ‚ÇΩ

–°–æ–∑–¥–∞—ë–º —Ä–∞—Å—Ö–æ–¥: 30 000 ‚ÇΩ

–ü—Ä–æ—Ü–µ—Å—Å:
1. BEFORE —Ç—Ä–∏–≥–≥–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: 20 000 - 30 000 = -10 000 ‚ÇΩ
2. –í–∏–¥–∏—Ç —á—Ç–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç 10 000 ‚ÇΩ
3. –°–ø–∏—Å—ã–≤–∞–µ—Ç –∏–∑ –∫—É–±—ã—à–∫–∏: 10 000 ‚ÇΩ
4. –ü–æ–ø–æ–ª–Ω—è–µ—Ç –∫–∞—Ä—Ç—É –∑–∞—Ä–∞–Ω–µ–µ: +10 000 ‚ÇΩ
5. –°–æ–∑–¥–∞—ë—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è -30 000 ‚ÇΩ
6. AFTER —Ç—Ä–∏–≥–≥–µ—Ä –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–≤–æ–¥–∞

–†–µ–∑—É–ª—å—Ç–∞—Ç:
- –ë–∞–ª–∞–Ω—Å –∫–∞—Ä—Ç—ã: 0 ‚ÇΩ ‚úÖ (–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –±—ã–ª –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º)
- –ë–∞–ª–∞–Ω—Å –∫—É–±—ã—à–∫–∏: 30 000 ‚ÇΩ
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥ –∏–∑ –∫—É–±—ã—à–∫–∏: 10 000 ‚ÇΩ
```

---

## üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏

### –ß–µ—Ä–µ–∑ Supabase Dashboard

1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–æ–µ–∫—Ç –≤ Supabase Dashboard
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª **SQL Editor**
3. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ `db/migrations/20251009_auto_stash_withdrawal.sql`
5. –í—Å—Ç–∞–≤—å—Ç–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–ø—Ä–æ—Å
6. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –∏ —Ç—Ä–∏–≥–≥–µ—Ä —Å–æ–∑–¥–∞–Ω—ã

### –ß–µ—Ä–µ–∑ Supabase CLI

```bash
# –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Supabase CLI
supabase db push

# –ò–ª–∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é
supabase migration up
```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∞

```sql
-- –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ç—Ä–∏–≥–≥–µ—Ä —Å–æ–∑–¥–∞–Ω
SELECT tgname, tgrelid::regclass
FROM pg_trigger
WHERE tgname = 'trigger_auto_withdraw_from_stash';

-- –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å:
-- trigger_auto_withdraw_from_stash | transactions
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–∏

```sql
-- –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞
SELECT proname, prosrc
FROM pg_proc
WHERE proname = 'auto_withdraw_from_stash';
```

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏

```typescript
// –í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:
// 1. –°–æ–∑–¥–∞–π—Ç–µ –∫–∞—Ä—Ç—É —Å –∫—É–±—ã—à–∫–æ–π (—Ü–µ–ª—å 50 000 ‚ÇΩ)
// 2. –ü–æ–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞ 100 000 ‚ÇΩ
// 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
//    - –ö—É–±—ã—à–∫–∞: 50 000 ‚ÇΩ
//    - –ö–∞—Ä—Ç–∞: 50 000 ‚ÇΩ
// 4. –°–æ–∑–¥–∞–π—Ç–µ —Ä–∞—Å—Ö–æ–¥ 60 000 ‚ÇΩ
// 5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
//    - –ö—É–±—ã—à–∫–∞: 40 000 ‚ÇΩ (—Å–ø–∏—Å–∞–ª–æ—Å—å 10 000 ‚ÇΩ)
//    - –ö–∞—Ä—Ç–∞: 0 ‚ÇΩ
```

---

## üìù –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤

–í—Å–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–µ—Ä–µ–≤–æ–¥—ã –∏–∑/–≤ –∫—É–±—ã—à–∫—É –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü—É `account_stash_transfers`:

```sql
SELECT 
  ast.*,
  t.note,
  t.amount
FROM account_stash_transfers ast
JOIN transactions t ON t.id = ast.transaction_id
WHERE stash_id = 'your-stash-id'
ORDER BY occurred_at DESC;
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–¶–µ–ª–µ–≤–∞—è —Å—É–º–º–∞ –∫—É–±—ã—à–∫–∏**
   - –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: 50 000 ‚ÇΩ
   - –ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —á–µ—Ä–µ–∑ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫—É–±—ã—à–∫–∏
   - –ï—Å–ª–∏ —Ü–µ–ª—å –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ - –∞–≤—Ç–æ–º–∞—Ç–∏–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

2. **–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –≤ –∫—É–±—ã—à–∫–µ**
   - –ï—Å–ª–∏ –≤ –∫—É–±—ã—à–∫–µ –º–µ–Ω—å—à–µ —á–µ–º –Ω—É–∂–Ω–æ
   - –°–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤—Å—ë —á—Ç–æ –µ—Å—Ç—å
   - –ö–∞—Ä—Ç–∞ –º–æ–∂–µ—Ç –æ—Å—Ç–∞—Ç—å—Å—è —Å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º –±–∞–ª–∞–Ω—Å–æ–º

3. **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏ –∏—Å—Ç–æ—Ä–∏—è**
   - –í—Å–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
   - –ú–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏–∏ –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –∫—É–±—ã—à–∫–∏
   - –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–º–µ—é—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏

---

## üîÑ –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏–∫–∏

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ:

```sql
-- –û—Ç–∫–ª—é—á–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä
ALTER TABLE transactions DISABLE TRIGGER trigger_auto_withdraw_from_stash;

-- –í–∫–ª—é—á–∏—Ç—å –æ–±—Ä–∞—Ç–Ω–æ
ALTER TABLE transactions ENABLE TRIGGER trigger_auto_withdraw_from_stash;
```

–ò–ª–∏ —É–¥–∞–ª–∏—Ç—å —Ü–µ–ª–µ–≤—É—é —Å—É–º–º—É —É –∫—É–±—ã—à–∫–∏ —á–µ—Ä–µ–∑ UI (—Ç–æ–≥–¥–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∫–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç).

---

## üîÑ –û—Ç–∫–∞—Ç –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

### –§–∞–π–ª: `db/migrations/20251009_auto_stash_rollback_on_delete.sql`

–ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∫–æ—Ç–æ—Ä–∞—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞ –¥–µ–Ω—å–≥–∏ –∏–∑ –∫—É–±—ã—à–∫–∏ - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Ö –æ–±—Ä–∞—Ç–Ω–æ.

**–õ–æ–≥–∏–∫–∞:**

```sql
BEFORE DELETE —Ç—Ä–∏–≥–≥–µ—Ä:
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –±—ã–ª–∞ –ª–∏ –∑–∞–ø–∏—Å—å –≤ account_stash_transfers
2. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–µ–Ω—å–≥–∏ –≤ –∫—É–±—ã—à–∫—É
3. –£–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –æ –ø–µ—Ä–µ–≤–æ–¥–µ
4. –ù–ï —Ç—Ä–æ–≥–∞–µ—Ç –±–∞–ª–∞–Ω—Å —Å—á—ë—Ç–∞!

–ü–û–°–õ–ï —Ç—Ä–∏–≥–≥–µ—Ä–∞ (deleteTransaction):
- reverseBalanceChange –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–æ–ª–Ω—É—é —Å—É–º–º—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–∞ —Å—á—ë—Ç
- –ò—Ç–æ–≥–æ–≤—ã–π –±–∞–ª–∞–Ω—Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π
```

**–ü—Ä–∏–º–µ—Ä:**

```text
–ë—ã–ª–æ: –∫–∞—Ä—Ç–∞ 10 000, –∫—É–±—ã—à–∫–∞ 20 000
–†–∞—Å—Ö–æ–¥: 25 000 (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∑—è—Ç–æ 15 000 –∏–∑ –∫—É–±—ã—à–∫–∏)
–°—Ç–∞–ª–æ: –∫–∞—Ä—Ç–∞ 0, –∫—É–±—ã—à–∫–∞ 5 000

–£–î–ê–õ–Ø–ï–ú —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é:
- BEFORE DELETE —Ç—Ä–∏–≥–≥–µ—Ä: –∫—É–±—ã—à–∫–∞ +15 000 = 20 000
- DELETE —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è
- reverseBalanceChange: –∫–∞—Ä—Ç–∞ +25 000 = 25 000
- –ù–û! –ö–∞—Ä—Ç–∞ –±—ã–ª–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∞ –Ω–∞ +15 000 –î–û —Ä–∞—Å—Ö–æ–¥–∞
- –ù—É–∂–Ω–æ —É–±—Ä–∞—Ç—å: 25 000 - 15 000 = 10 000
- –ò—Ç–æ–≥–æ: –∫–∞—Ä—Ç–∞ 10 000 ‚úÖ, –∫—É–±—ã—à–∫–∞ 20 000 ‚úÖ

–í–ê–ñ–ù–û: reverseBalanceChange –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å—É–º–º—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
–¢—Ä–∏–≥–≥–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–µ–Ω—å–≥–∏ –≤ –∫—É–±—ã—à–∫—É.
–ë–∞–ª–∞–Ω—Å —Å—á—ë—Ç–∞ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
```

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `app/(protected)/cards/actions.ts` - Server Actions
- `app/(protected)/cards/AddFundsModal.tsx` - UI –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
- `db/migrations/20251009_auto_stash_withdrawal.sql` - –¢—Ä–∏–≥–≥–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è
- `db/migrations/20251009_auto_stash_rollback_on_delete.sql` - –¢—Ä–∏–≥–≥–µ—Ä –æ—Ç–∫–∞—Ç–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏
- `lib/transactions/service.ts` - –§—É–Ω–∫—Ü–∏—è deleteTransaction
- `app/(protected)/cards/page.tsx` - –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∫–∞—Ä—Ç

---

**–ê–≤—Ç–æ—Ä:** AI Assistant  
**–î–∞—Ç–∞:** 09.10.2025  
**–í–µ—Ä—Å–∏—è:** 2.0
