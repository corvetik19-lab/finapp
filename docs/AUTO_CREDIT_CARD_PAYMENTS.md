# Автоматическое создание платежей по кредитным картам

## Описание

Система автоматически создаёт напоминания о платежах по кредитным картам **за 10 дней до срока оплаты**.

## Как это работает

### 1. Данные кредитных карт

На странице **"Кредитные карты"** для каждой карты указываются:
- **Дата следующего платежа** (`next_payment_date`)
- **Минимальный платёж** (`min_payment`)
- **Текущая задолженность** (`balance`)

### 2. Условия создания платежа

Платёж создаётся автоматически, если:
- ✅ Карта имеет тип `card` с установленным кредитным лимитом
- ✅ Карта не удалена
- ✅ Есть задолженность (`balance > 0`)
- ✅ Указана дата следующего платежа
- ✅ До даты платежа осталось **≤ 10 дней**
- ✅ Дата платежа ещё не прошла
- ✅ Для этой карты ещё нет платежа на эту дату

### 3. Параметры создаваемого платежа

```
Название: "Платёж по карте: [Название карты]"
Дата: [next_payment_date]
Сумма: max(min_payment, balance) - больше из двух значений
Тип: Расход
Счёт: [Привязан к карте]
Описание: "Автоматически создано за 10 дней до срока оплаты"
```

## Расписание запуска

CRON задача выполняется **ежедневно в 9:00 UTC (12:00 по МСК)**.

## Ручной запуск (для тестирования)

### Через SQL:
```sql
SELECT * FROM auto_create_credit_card_payments();
```

### Через API:
```bash
POST /api/cron/credit-card-payments
Authorization: Bearer YOUR_CRON_SECRET
```

Ответ:
```json
{
  "success": true,
  "result": [{"created_count": 2, "message": "Создано платежей: 2"}],
  "message": "Создано платежей: 2"
}
```

## Пример работы

### Исходные данные:

**Кредитная карта "Тинькофф":**
- Дата следующего платежа: **30 октября 2025**
- Минимальный платёж: **5 000 ₽**
- Задолженность: **45 000 ₽**

### Временная шкала:

```
5 окт ─────────────── 20 окт ─────────────── 30 окт
Сегодня              [Создание           [Дата платежа]
                      платежа]
                      ↓
                 За 10 дней
```

### Результат:

**20 октября** система создаст платёж:
```
Название: "Платёж по карте: Тинькофф"
Дата: 30.10.2025
Сумма: 45 000 ₽  (берётся max из 5000 и 45000)
Статус: Ожидается
```

## Защита от дубликатов

Функция проверяет наличие существующего платежа:
- По `user_id`
- По `account_name` (название карты)
- По дате (`DATE(due_date) = next_payment_date`)
- По статусу (`status = 'pending'`)

Если платёж уже существует - новый не создаётся.

## Мониторинг

### Проверить статус CRON задачи:

```sql
SELECT * FROM cron.job WHERE jobname = 'auto-create-credit-card-payments';
```

### Посмотреть историю выполнения:

```sql
SELECT * FROM cron.job_run_details 
WHERE jobid = (SELECT jobid FROM cron.job WHERE jobname = 'auto-create-credit-card-payments')
ORDER BY start_time DESC
LIMIT 10;
```

## Настройка

### Изменить расписание:

```sql
-- Удалить старую задачу
SELECT cron.unschedule('auto-create-credit-card-payments');

-- Создать с новым расписанием (например, каждый день в 6:00 UTC)
SELECT cron.schedule(
  'auto-create-credit-card-payments',
  '0 6 * * *',
  $$SELECT * FROM auto_create_credit_card_payments()$$
);
```

### Изменить период (например, за 7 дней вместо 10):

Отредактировать функцию в миграции:
```sql
-- Изменить условие:
AND a.next_payment_date <= CURRENT_DATE + INTERVAL '7 days'
```

## Troubleshooting

### Платежи не создаются

1. Проверьте данные кредитных карт:
   ```sql
   SELECT name, balance, next_payment_date 
   FROM accounts 
   WHERE type = 'card' AND credit_limit IS NOT NULL;
   ```

2. Проверьте условия:
   - Есть ли задолженность?
   - Указана ли дата платежа?
   - Осталось ли ≤ 10 дней до платежа?

3. Запустите функцию вручную и проверьте результат:
   ```sql
   SELECT * FROM auto_create_credit_card_payments();
   ```

### CRON не запускается

Проверьте что расширение `pg_cron` включено:
```sql
SELECT * FROM pg_extension WHERE extname = 'pg_cron';
```

## Безопасность

- Функция работает только с данными авторизованных пользователей
- API endpoint защищён через `CRON_SECRET` (опционально)
- RLS политики применяются ко всем операциям
