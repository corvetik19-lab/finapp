{
  "name": "–§–ù–° Telegram ‚Üí AI ‚Üí Finappka",
  "nodes": [
    {
      "parameters": {
        "updates": ["message"]
      },
      "id": "telegram-trigger",
      "name": "Telegram Bot",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [250, 300],
      "webhookId": "telegram-fns-bot",
      "credentials": {
        "telegramApi": {
          "id": "REPLACE_WITH_YOUR_TELEGRAM_BOT_CREDENTIAL",
          "name": "–§–ù–° Bot"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç —á–µ–∫–∞ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è Telegram\nconst message = $input.all()[0].json.message;\nconst text = message.text || '';\n\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ —á–µ–∫ –æ—Ç –§–ù–°\nif (!text.includes('–∫–∞—Å—Å–æ–≤—ã–π —á–µ–∫') && !text.includes('–ö–ö–¢') && !text.includes('–ò—Ç–æ–≥–æ:')) {\n  // –≠—Ç–æ –Ω–µ —á–µ–∫, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º\n  return [];\n}\n\n// –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —á–µ–∫–∞\nconst lines = text.split('\\n');\nlet totalAmount = 0;\nlet items = [];\nlet shopName = '';\nlet date = new Date().toISOString();\n\n// –ò—â–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞ –≤ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ\n// –§–æ—Ä–º–∞—Ç: \"–ü–æ—Å—Ç—É–ø–∏–ª –∫–∞—Å—Å–æ–≤—ã–π —á–µ–∫: –æ—Ç –ê–û \\\"–¢–ê–ù–î–ï–†\\\"\"\nconst shopMatch = text.match(/–∫–∞—Å—Å–æ–≤—ã–π —á–µ–∫:\\s*–æ—Ç\\s+(.+?)\\s*\\n/);\nif (shopMatch) {\n  shopName = shopMatch[1].trim().replace(/\\\"/g, '');\n}\n\n// –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –∏—â–µ–º \"–ú–µ—Å—Ç–æ —Ä–∞—Å—á–µ—Ç–æ–≤\"\nif (!shopName) {\n  const placeMatch = text.match(/–ú–µ—Å—Ç–æ —Ä–∞—Å—á–µ—Ç–æ–≤:\\s*(.+?)\\n/);\n  if (placeMatch) {\n    shopName = placeMatch[1].trim();\n  }\n}\n\n// –ò—â–µ–º –¥–∞—Ç—É\nconst dateMatch = text.match(/–î–∞—Ç–∞:\\s*(\\d{2})\\.(\\d{2})\\.(\\d{4})\\s+(\\d{2}):(\\d{2})/);\nif (dateMatch) {\n  date = `${dateMatch[3]}-${dateMatch[2]}-${dateMatch[1]}T${dateMatch[4]}:${dateMatch[5]}:00Z`;\n}\n\n// –ü–∞—Ä—Å–∏–º —Ç–æ–≤–∞—Ä—ã\n// –§–æ—Ä–º–∞—Ç:\n// 1. –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞\n// —Ü–µ–Ω–∞ x –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ = –∏—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞ —Ä—É–±.\nlet i = 0;\nwhile (i < lines.length) {\n  const line = lines[i].trim();\n  \n  // –ò—â–µ–º —Å—Ç—Ä–æ–∫—É —Å –Ω–æ–º–µ—Ä–æ–º —Ç–æ–≤–∞—Ä–∞: \"1. –ù–∞–∑–≤–∞–Ω–∏–µ\"\n  const itemHeaderMatch = line.match(/^(\\d+)\\.\\s+(.+)$/);\n  \n  if (itemHeaderMatch && i + 1 < lines.length) {\n    const itemName = itemHeaderMatch[2].trim();\n    const nextLine = lines[i + 1].trim();\n    \n    // –°–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ü–µ–Ω—É: \"47.99 x 1.0 = 47.99 —Ä—É–±.\"\n    const priceMatch = nextLine.match(/([\\d.]+)\\s*x\\s*([\\d.]+)\\s*=\\s*([\\d.]+)\\s*—Ä—É–±/);\n    \n    if (priceMatch) {\n      const unitPrice = parseFloat(priceMatch[1]);\n      const quantity = parseFloat(priceMatch[2]);\n      const totalPrice = parseFloat(priceMatch[3]);\n      \n      items.push({\n        name: itemName,\n        price: totalPrice,\n        unit_price: unitPrice,\n        quantity: quantity\n      });\n      \n      i += 2; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±–µ —Å—Ç—Ä–æ–∫–∏\n      continue;\n    }\n  }\n  \n  // –ò—â–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É\n  if (line.startsWith('–ò—Ç–æ–≥–æ:')) {\n    const totalMatch = line.match(/–ò—Ç–æ–≥–æ:\\s*([\\d.]+)\\s*—Ä—É–±/);\n    if (totalMatch) {\n      totalAmount = parseFloat(totalMatch[1]);\n    }\n    break; // –î–∞–ª—å—à–µ —á–∏—Ç–∞—Ç—å –Ω–µ –Ω—É–∂–Ω–æ\n  }\n  \n  i++;\n}\n\n// –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É - —Å—á–∏—Ç–∞–µ–º –∏–∑ —Ç–æ–≤–∞—Ä–æ–≤\nif (totalAmount === 0 && items.length > 0) {\n  totalAmount = items.reduce((sum, item) => sum + item.price, 0);\n}\n\n// –ï—Å–ª–∏ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç\nif (items.length === 0) {\n  return [];\n}\n\nreturn [{\n  json: {\n    raw_text: text,\n    shop_name: shopName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω',\n    date: date,\n    total_amount: totalAmount,\n    items: items,\n    items_count: items.length\n  }\n}];"
      },
      "id": "parse-receipt",
      "name": "Parse Receipt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [470, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-items",
              "leftValue": "={{ $json.items_count }}",
              "rightValue": "0",
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-valid",
      "name": "Valid Receipt?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [690, 300]
    },
    {
      "parameters": {
        "resource": "chat",
        "operation": "sendMessage",
        "chatId": "={{ $json.message.chat.id }}",
        "text": "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —á–µ–∫. –ü–æ–ø—Ä–æ–±—É–π –ø–µ—Ä–µ—Å–ª–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –§–ù–° –±–æ—Ç–∞.",
        "additionalFields": {}
      },
      "id": "send-error",
      "name": "Send Error",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [910, 400],
      "credentials": {
        "telegramApi": {
          "id": "REPLACE_WITH_YOUR_TELEGRAM_BOT_CREDENTIAL",
          "name": "–§–ù–° Bot"
        }
      }
    },
    {
      "parameters": {
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "resource": "chat",
        "operation": "create",
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "messages": {
          "values": [
            {
              "role": "system",
              "content": "–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–∫—É–ø–æ–∫. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–æ–≤–∞—Ä—ã –∏–∑ —á–µ–∫–∞ –ø–æ –ª–æ–≥–∏—á–µ—Å–∫–∏–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º.\n\n–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:\n- –ü—Ä–æ–¥—É–∫—Ç—ã (–µ–¥–∞, –Ω–∞–ø–∏—Ç–∫–∏, –ø—Ä–æ–¥—É–∫—Ç—ã –ø–∏—Ç–∞–Ω–∏—è)\n- –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç (—Ç–∞–∫—Å–∏, –±–µ–Ω–∑–∏–Ω, –ø–∞—Ä–∫–æ–≤–∫–∞, –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç)\n- –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è (–∫–∏–Ω–æ, –∏–≥—Ä—ã, –ø–æ–¥–ø–∏—Å–∫–∏, —Ö–æ–±–±–∏)\n- –ó–¥–æ—Ä–æ–≤—å–µ (–∞–ø—Ç–µ–∫–∞, –≤—Ä–∞—á–∏, —Å–ø–æ—Ä—Ç, —Ñ–∏—Ç–Ω–µ—Å)\n- –û–¥–µ–∂–¥–∞ (–æ–¥–µ–∂–¥–∞, –æ–±—É–≤—å, –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã)\n- –î–æ–º (–º–µ–±–µ–ª—å, —Ç–µ—Ö–Ω–∏–∫–∞, —Ä–µ–º–æ–Ω—Ç, –∫–æ–º–º—É–Ω–∞–ª–∫–∞)\n- –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ (–∫–Ω–∏–≥–∏, –∫—É—Ä—Å—ã, –æ–±—É—á–µ–Ω–∏–µ)\n- –ö–∞—Ñ–µ/–†–µ—Å—Ç–æ—Ä–∞–Ω—ã (–∫–∞—Ñ–µ, —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã, —Ñ–∞—Å—Ç—Ñ—É–¥)\n- –ü—Ä–æ—á–µ–µ (–≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ)\n\n–í–µ—Ä–Ω–∏ JSON –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n{\n  \"items\": [\n    {\n      \"name\": \"–Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞\",\n      \"price\": —Ü–µ–Ω–∞,\n      \"category\": \"–∫–∞—Ç–µ–≥–æ—Ä–∏—è\"\n    }\n  ],\n  \"main_category\": \"–æ—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è –¥–ª—è –≤—Å–µ–≥–æ —á–µ–∫–∞\"\n}"
            },
            {
              "role": "user",
              "content": "=–ú–∞–≥–∞–∑–∏–Ω: {{ $json.shop_name }}\n–î–∞—Ç–∞: {{ $json.date }}\n–ò—Ç–æ–≥–æ: {{ $json.total_amount }}‚ÇΩ\n\n–¢–æ–≤–∞—Ä—ã:\n{{ $json.items.map(item => `- ${item.name}: ${item.price}‚ÇΩ`).join('\\n') }}\n\n–†–∞—Å–ø—Ä–µ–¥–µ–ª–∏ —Ç–æ–≤–∞—Ä—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º."
            }
          ]
        },
        "options": {
          "temperature": 0.3
        }
      },
      "id": "ai-categorize",
      "name": "AI Categorize",
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 1.4,
      "position": [910, 200],
      "credentials": {
        "openAiApi": {
          "id": "REPLACE_WITH_YOUR_OPENAI_CREDENTIAL",
          "name": "OpenAI"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç –æ—Ç AI\nconst aiResponse = $input.all()[0].json.choices[0].message.content;\nconst originalData = $input.all()[0].json;\n\n// –ò–∑–≤–ª–µ–∫–∞–µ–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞ AI\nlet categorizedData;\ntry {\n  // –ò—â–µ–º JSON –≤ –æ—Ç–≤–µ—Ç–µ (–º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±—ë—Ä–Ω—É—Ç –≤ ```json```)\n  const jsonMatch = aiResponse.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) {\n    categorizedData = JSON.parse(jsonMatch[0]);\n  } else {\n    throw new Error('No JSON found');\n  }\n} catch (error) {\n  // –ï—Å–ª–∏ AI –Ω–µ –≤–µ—Ä–Ω—É–ª –≤–∞–ª–∏–¥–Ω—ã–π JSON, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é\n  categorizedData = {\n    items: originalData.items.map(item => ({\n      name: item.name,\n      price: item.price,\n      category: '–ü—Ä–æ—á–µ–µ'\n    })),\n    main_category: '–ü—Ä–æ—á–µ–µ'\n  };\n}\n\nreturn [{\n  json: {\n    shop_name: originalData.shop_name,\n    date: originalData.date,\n    total_amount: originalData.total_amount,\n    items: categorizedData.items,\n    main_category: categorizedData.main_category,\n    raw_text: originalData.raw_text\n  }\n}];"
      },
      "id": "parse-ai-response",
      "name": "Parse AI Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1130, 200]
    },
    {
      "parameters": {
        "url": "={{$env.FINAPPKA_BASE_URL}}/api/v1/receipts/import",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "shop_name",
              "value": "={{ $json.shop_name }}"
            },
            {
              "name": "date",
              "value": "={{ $json.date }}"
            },
            {
              "name": "total_amount",
              "value": "={{ Math.round($json.total_amount * 100) }}"
            },
            {
              "name": "items",
              "value": "={{ JSON.stringify($json.items) }}"
            },
            {
              "name": "main_category",
              "value": "={{ $json.main_category }}"
            },
            {
              "name": "raw_text",
              "value": "={{ $json.raw_text }}"
            }
          ]
        },
        "options": {}
      },
      "id": "import-to-finappka",
      "name": "Import to Finappka",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1350, 200],
      "credentials": {
        "httpHeaderAuth": {
          "id": "REPLACE_WITH_YOUR_FINAPPKA_CREDENTIAL",
          "name": "Finappka API"
        }
      }
    },
    {
      "parameters": {
        "resource": "chat",
        "operation": "sendMessage",
        "chatId": "={{ $input.all()[0].json.message.chat.id }}",
        "text": "=‚úÖ –ß–µ–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω!\n\nüè™ –ú–∞–≥–∞–∑–∏–Ω: {{ $json.shop_name }}\nüí∞ –°—É–º–º–∞: {{ $json.total_amount }}‚ÇΩ\nüìÅ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {{ $json.main_category }}\n\nüì¶ –¢–æ–≤–∞—Ä—ã:\n{{ $json.items.map(item => `‚Ä¢ ${item.name} - ${item.price}‚ÇΩ (${item.category})`).join('\\n') }}\n\n‚ú® –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω—ã –≤ Finappka!",
        "additionalFields": {
          "parseMode": "Markdown"
        }
      },
      "id": "send-success",
      "name": "Send Success",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1570, 200],
      "credentials": {
        "telegramApi": {
          "id": "REPLACE_WITH_YOUR_TELEGRAM_BOT_CREDENTIAL",
          "name": "–§–ù–° Bot"
        }
      }
    }
  ],
  "connections": {
    "Telegram Bot": {
      "main": [
        [
          {
            "node": "Parse Receipt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Receipt": {
      "main": [
        [
          {
            "node": "Valid Receipt?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Valid Receipt?": {
      "main": [
        [
          {
            "node": "AI Categorize",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Categorize": {
      "main": [
        [
          {
            "node": "Parse AI Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse AI Response": {
      "main": [
        [
          {
            "node": "Import to Finappka",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Import to Finappka": {
      "main": [
        [
          {
            "node": "Send Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": {},
  "tags": [
    {
      "createdAt": "2024-10-23T00:00:00.000Z",
      "updatedAt": "2024-10-23T00:00:00.000Z",
      "id": "finappka",
      "name": "finappka"
    }
  ],
  "triggerCount": 0,
  "updatedAt": "2024-10-23T00:00:00.000Z",
  "versionId": "1"
}
